import os
import shutil
import tempfile
import pytest
from pathlib import Path
from unittest.mock import patch
import traceback

from hydra import compose, initialize
from hydra.core.global_hydra import GlobalHydra

from counterfactuals.datasets.file_dataset import FileDataset
from counterfactuals.pipelines.run_ppcef_pipeline import (
    search_counterfactuals,
    calculate_metrics,
)
from counterfactuals.pipelines.run_globe_ce_pipeline import (
    search_counterfactuals as search_counterfactuals_globe_ce,
    calculate_metrics as calculate_metrics_globe_ce,
)
from counterfactuals.pipelines.full_pipeline.full_pipeline import full_pipeline
from counterfactuals.preprocessing import (
    PreprocessingPipeline,
    MinMaxScalingStep,
    TorchDataTypeStep,
)


def test_german_credit_initialization():
    # Construct absolute path to the config file
    project_root = Path(__file__).parent.parent.parent
    config_path = project_root / "config/datasets/german_credit.yaml"
    
    # Initialize the dataset
    dataset = FileDataset(config_path=config_path)
    
    # Assertions to verify initialization
    assert dataset.X is not None
    assert dataset.y is not None
    assert len(dataset.X) > 0
    assert len(dataset.y) > 0
    assert dataset.X.shape[0] == dataset.y.shape[0]
    
    # Verify features are loaded
    assert len(dataset.features) > 0
    assert dataset.X.shape[1] == len(dataset.features)


def test_german_credit_ppcef_execution():
    """
    Integration test to verify that PPCEF pipeline runs on German Credit dataset.
    """
    with tempfile.TemporaryDirectory() as tmp_dir:
        GlobalHydra.instance().clear()
        config_dir = "../../counterfactuals/pipelines/conf"
        
        try:
            with initialize(version_base="1.2", config_path=config_dir):
                cfg = compose(
                    config_name="ppcef_config",
                    overrides=[
                        "dataset.config_path=config/datasets/german_credit.yaml",
                        "++dataset.samples_keep=500",
                        "disc_model.train_model=true",
                        "disc_model.epochs=3",
                        "disc_model.batch_size=16",
                        "disc_model.patience=1",
                        "gen_model.train_model=true",
                        "gen_model.epochs=3",
                        "gen_model.batch_size=16",
                        "gen_model.patience=1",
                        "counterfactuals_params.epochs=3",
                        "counterfactuals_params.batch_size=16",
                        f"experiment.output_folder={tmp_dir}",
                    ]
                )
        except ValueError as e:
            pytest.skip(f"Hydra initialization failed: {e}")

        with patch("logging.getLogger"):
            preprocessing_pipeline = PreprocessingPipeline(
                [
                    ("minmax", MinMaxScalingStep()),
                    ("torch_dtype", TorchDataTypeStep()),
                ]
            )
            
            try:
                from logging import getLogger
                test_logger = getLogger("test_logger")
                
                full_pipeline(
                    cfg,
                    preprocessing_pipeline,
                    test_logger,
                    search_counterfactuals,
                    calculate_metrics
                )
            except Exception as e:
                if "tensorflow" in str(e).lower() or "dll" in str(e).lower():
                    pytest.skip(f"Skipping due to environment issue: {e}")
                else:
                    traceback.print_exc()
                    pytest.fail(f"PPCEF pipeline execution failed with error: {e}")
            
            output_path = Path(tmp_dir)
            files = list(output_path.glob("**/*.csv")) + list(output_path.glob("**/*.pt")) + list(output_path.glob("**/*.pth"))
            assert len(files) > 0, "No output files were generated by the pipeline"


def test_german_credit_globe_ce_execution():
    """
    Integration test to verify that GLOBE-CE pipeline runs on German Credit dataset.
    """
    with tempfile.TemporaryDirectory() as tmp_dir:
        GlobalHydra.instance().clear()
        config_dir = "../../counterfactuals/pipelines/conf"

        try:
            with initialize(version_base="1.2", config_path=config_dir):
                cfg = compose(
                    config_name="globe_ce_config",
                    overrides=[
                        "dataset.config_path=config/datasets/german_credit.yaml",
                        "++dataset.samples_keep=500",
                        "disc_model.train_model=true",
                        "disc_model.epochs=3",
                        "disc_model.batch_size=16",
                        "disc_model.patience=1",
                        "gen_model.train_model=true",
                        "gen_model.epochs=3",
                        "gen_model.batch_size=16",
                        "gen_model.patience=1",
                        "++counterfactuals_params.limit_samples=2",                        
                        "counterfactuals_params.batch_size=16",
                        "counterfactuals_params.target_class=0",
                        f"experiment.output_folder={tmp_dir}",
                    ]
                )
        except ValueError as e:
            pytest.skip(f"Hydra initialization failed: {e}")
        
        preprocessing_pipeline = PreprocessingPipeline(
            [
                ("torch_dtype", TorchDataTypeStep()),
                ("minmax", MinMaxScalingStep()),
            ]
        )

        with patch("logging.getLogger"):
            try:
                from logging import getLogger
                test_logger = getLogger("test_logger")

                full_pipeline(
                    cfg,
                    preprocessing_pipeline,
                    test_logger,
                    search_counterfactuals_globe_ce,
                    calculate_metrics_globe_ce
                )
            except Exception as e:
                 if "tensorflow" in str(e).lower() or "dll" in str(e).lower():
                    pytest.skip(f"Skipping due to environment issue: {e}")
                 else:
                    traceback.print_exc()
                    pytest.fail(f"GLOBE-CE pipeline execution failed with error: {e}")

            output_path = Path(tmp_dir)
            files = list(output_path.glob("**/*.csv")) + list(output_path.glob("**/*.pt")) + list(output_path.glob("**/*.pth"))
            assert len(files) > 0, "No output files were generated by the pipeline"
